<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="/css/mastodon-timeline.min.css">
    
    
    <title>instantiator.dev | Bucket List - the bucket that wouldn&#39;t die</title>
    
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-SHE42ZWKEN"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-SHE42ZWKEN');
        }
      </script>
    
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://instantiator.dev/bucket-list/bucket-list-graphic.png">
  <meta name="twitter:title" content="Bucket List - the bucket that wouldn&#39;t die">
  <meta name="twitter:description" content="When the time comes to delete an old S3 bucket, itâ€™s important to know that they canâ€™t be deleted while they contain content. Hereâ€™s what you can do about it from the CLIâ€¦">

    <meta property="og:url" content="https://instantiator.dev/post/emptying-s3-buckets/">
  <meta property="og:site_name" content="instantiator.dev">
  <meta property="og:title" content="Bucket List - the bucket that wouldn&#39;t die">
  <meta property="og:description" content="When the time comes to delete an old S3 bucket, itâ€™s important to know that they canâ€™t be deleted while they contain content. Hereâ€™s what you can do about it from the CLIâ€¦">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-02-22T11:00:00+00:00">
    <meta property="article:modified_time" content="2025-02-22T11:00:00+00:00">
    <meta property="article:tag" content="Coding">
    <meta property="article:tag" content="Infrastructure">
    <meta property="article:tag" content="Aws">
    <meta property="article:tag" content="Amazon-Web-Services">
    <meta property="article:tag" content="S3">
    <meta property="article:tag" content="Bucket">
    <meta property="og:image" content="https://instantiator.dev/bucket-list/bucket-list-graphic.png">


    
    <link rel="stylesheet"
        href="/css/markupHighlight.min.59c08a266e8a6489aab7cb3ace4259db920d0e8893682a44ef8401387af97664.css"
        integrity="sha256-WcCKJm6KZImqt8s6zkJZ25INDoiTaCpE74QBOHr5dmQ="
        crossorigin="anonymous"
        type="text/css">

    </head><body><nav id="nav" class="navbar sticky-top justify-content-start navbar-expand-md frosted-white shadow mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">instantiator.dev</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav">
        
        
        <li class="nav-item">
          <a class="nav-link " href="/">
            
             Home
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link " href="/post/">
            
             All posts
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link " href="/categories/tool/">
            
             Tools
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link " href="/categories/tutorial/">
            
             Tutorials
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link " href="/categories/article/">
            
             Articles
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link " href="/about/">
            
             About
          </a>
        </li>
        
      </ul>
    </div>
  </div>
</nav>
<div class="container-fluid">

<div class="row align-items-start">
    <div class="col col-lg-3 d-none d-lg-block">
      <div class="row mb-2">
    <div class="col-3 col-lg-12 d-flex flex-column align-items-center">
        <img 
            src="/lewis/profile.jpg" alt="profile picture" 
            class="mb-4 mt-4 img-thumbnail" 
            style="border-radius: 50%; max-width: 200px; width: 100%;" />
    </div>
    <div class="col d-flex flex-column align-items-center">
        <h3 class="mb-4"><a href="/">instantiator.dev</a></h3>
        
        <div style="text-align: center;" class="mb-4">
            <p style="font-size: 0.8rem;">tech, volunteers, public safety, collective intelligence, articles, tools, code and ideas</p>
        </div>

        <div class="d-flex flex-row justify-content-evenly align-self-stretch mb-4">
            
            <a href="https://mastodon.social/@instantiator" rel="me" aria-label="Mastodon account" alt="Mastodon account" target="_blank">
                
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 418 512" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"></path></svg> 
                
            </a>
            
            <a href="https://bsky.app/profile/instantiator.bsky.social" rel="me" aria-label="BlueSky account" alt="BlueSky account" target="_blank">
                
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 600 530" fill="currentColor" stroke="currentColor" version="1.1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
                </svg>
                
            </a>
            
            <a href="https://github.com/instantiator" rel="me" aria-label="GitHub account" alt="GitHub account" target="_blank">
                
                <i data-feather="github" aria-hidden="true"></i>
                
            </a>
            
            <a href="https://www.linkedin.com/in/lewiswestbury" rel="me" aria-label="LinkedIn account" alt="LinkedIn account" target="_blank">
                
                <i data-feather="linkedin" aria-hidden="true"></i>
                
            </a>
            
            <a href="https://calendar.google.com/calendar/embed?src=ad7606dfb0580dc089629dff9be0d9fc0db19d296a7d72864c1b338f4dd896a4%40group.calendar.google.com&amp;ctz=Europe%2FLondon" rel="me" aria-label="Celebrations calendar" alt="Celebrations calendar" target="_blank">
                
                <i data-feather="calendar" aria-hidden="true"></i>
                
            </a>
            
            <a href="https://instantiator.dev/index.xml" rel="me" aria-label="RSS" alt="RSS" target="_blank">
                
                <i data-feather="rss" aria-hidden="true"></i>
                
            </a>
            
        </div>

        <div class="d-flex flex-row justify-content-evenly align-self-stretch mb-4" style="font-size: 0.8rem;">
            <ul style="padding-inline-start: 0;">
            
                <li><a href="https://instantiator.dev/presence" rel="me" aria-label="Presence" target="_blank">Presence</a> (tool) (in dev)</li>
            
                <li><a href="https://instantiator.dev/listsky/" rel="me" aria-label="ListSky" target="_blank">ListSky</a> (tool) (in dev)</li>
            
                <li><a href="https://epistolorean.club" rel="me" aria-label="The Epistolorean" target="_blank">The Epistolorean</a> (service)</li>
            
                <li><a href="https://icgames.net" rel="me" aria-label="Consensus Games" target="_blank">Consensus Games</a> (service) (in dev)</li>
            
                <li><a href="https://instantiator.dev/json-to-smart-csv/" rel="me" aria-label="JSON to Smart CSV" target="_blank">JSON to Smart CSV</a> (tool)</li>
            
                <li><a href="https://www.escapethereview.co.uk/profile/?user_id=11" rel="me" aria-label="Escape the Review" target="_blank">Escape the Review</a> (profile)</li>
            
                <li><a href="https://calendar.google.com/calendar/embed?src=ad7606dfb0580dc089629dff9be0d9fc0db19d296a7d72864c1b338f4dd896a4%40group.calendar.google.com&amp;ctz=Europe%2FLondon" rel="me" aria-label="In this house..." target="_blank">In this house...</a> (calendar)</li>
            
            </ul>
        </div>

        <div>
            <span class="text-body-secondary fw-lighter" style="font-size: 0.8rem;">
                &copy; Lewis Westbury  2026 
            </span>
        </div>
    </div>
</div>    



    </div>
    <div class="col-lg" style="overflow-x: hidden;">
        <div id="post-content">
            <h2 style="display: inline-block;">Bucket List - the bucket that wouldn&#39;t die</h2>
                
                    
                        
                        <a class="badge bg-primary" href="https://instantiator.dev/categories/tutorial">tutorial</a>
                    
                
            <div class="mt-2">
                 

<div class="mb-2">
    <i data-feather="calendar"></i>
    <time datetime="2025-02-22">2025-02-22</time>
</div>

<div>
    <i data-feather="tag"></i>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/coding">#coding</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/infrastructure">#infrastructure</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/aws">#aws</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/amazon-web-services">#amazon-web-services</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/s3">#s3</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/bucket">#bucket</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/empty">#empty</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/delete">#delete</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/cli">#cli</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/aws-cli">#aws-cli</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/script">#script</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/bash">#bash</a>
    
        
        <a class="badge bg-secondary" href="https://instantiator.dev/tags/shell">#shell</a>
    
</div>


            </div>
            <div class="mt-4">
                <p><em>When the time comes to delete an old S3 bucket, it&rsquo;s important to know that they can&rsquo;t be deleted while they contain content. Here&rsquo;s what you can do about it from the CLI&hellip;</em></p>
<h1 id="simple-job-right">Simple job, right?</h1>
<p>This is a sensible precaution, I guess, but it&rsquo;s frustrating at times. Especially when working with the AWS command line tools. The issue is compounded when the bucket is versioned - and we&rsquo;ll get into that.</p>
<p>Before we get started, though, if you just want a script that makes it easy to empty a versioned S3 bucket, see:</p>
<ul>
<li><a href="https://gist.github.com/instantiator/093b1727b1cf16e77dfa3218d1957610"><code>empty-bucket.sh</code></a></li>
</ul>
<blockquote>
<p>This script is built around some solutions <a href="https://stackoverflow.com/a/61123579">presented</a> on StackOverflow. I&rsquo;m extremely grateful to the author, <a href="https://stackoverflow.com/users/5174358/alexandre-hamon">Alexandre Hamon</a>, for openly sharing his solution way back in 2020. I&rsquo;ve built on it to develop a full script with a nice interface, but it wouldn&rsquo;t have been possible without the ability to learn from others - especially in cases like these where official documentation falls short.</p>
</blockquote>
<h2 id="-bucket-list">ðŸŽ­ Bucket List</h2>
<p><em>A 3-act autobiographical play about a man who wants to delete a bucket.</em></p>
<h3 id="dramatis-personae">Dramatis personae</h3>
<pre tabindex="0"><code>Lewis ... ... ... protagonist ... ... would like to delete a bucket
AWS   ... ... ... villain     ... ... a counter-deletion revolutionary
</code></pre><h3 id="act-1---objects-in-the-dark">Act 1 - objects in the dark</h3>
<p>Wishing to delete a bucket, Lewis naively deletes every object in it, confident in his strongly-held belief that this is how you delete everything in a bucket. To his surprise, the bucket cannot be deleted because it is not empty!</p>
<h3 id="act-2---its-versions-all-the-way-down">Act 2 - it&rsquo;s versions all the way down</h3>
<p>On discovering that the bucket is still not empty and cannot be deleted, Lewis deletes every version of every object in the bucket, because it is a versioned bucket and naively deleting the objects did not delete previous versions. To his surprise, the bucket still cannot be deleted, because it is still not empty!</p>
<h3 id="act-3---who-will-delete-the-deletions">Act 3 - who will delete the deletions?</h3>
<p>Driven almost to the brink of madness, Lewis deletes every deletion marker in the bucket left behind by the previous deletions. Now the bucket is truly empty. He deletes the bucket and finds peace with the world, his debt to society paid in full.</p>
<h1 id="what-can-we-learn">What can we learn?</h1>
<p>If you enable versioning on your buckets, you&rsquo;ll be able to retrieve previous versions of files stored in your bucket. This is a handy feature to help you recover from overwriting good content with bad, and accidental deletions - but it leaves a trail of additional data and metadata.</p>
<p>When the time comes to delete your bucket, you&rsquo;ll find that first you need to empty it of content. If you do it from the AWS web console, it&rsquo;s reasonably straightforward (if clunky). First it&rsquo;ll tell you it can delete the bucket because it isn&rsquo;t empty. Then it&rsquo;ll offer you the option of emptying the bucket. Once emptied, you can return to deletion and try again.</p>
<p>Using the AWS CLI from a shell prompt, it&rsquo;s a little harder!</p>
<h2 id="deleting-objects">Deleting objects</h2>
<p>You can delete every object from a regular S3 bucket with the <code>rm</code> command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3 rm s3://<span style="color:#e6db74">${</span>BUCKET<span style="color:#e6db74">}</span> --region <span style="color:#e6db74">${</span>REGION<span style="color:#e6db74">}</span> --recursive
</span></span></code></pre></div><p>The <code>--region</code> parameter is optional, provided you can reach and control your bucket from your default region. Otherwise provide a value of your own.</p>
<p>The <code>--recursive</code> parameter indicates that everything in the bucket should be deleted.</p>
<p>However, that&rsquo;s not enough - this leaves behind:</p>
<ul>
<li>Previous versions of all the objects in the bucket</li>
<li>Deletion records of everything deleted!</li>
</ul>
<p>If you want to delete the bucket, you&rsquo;re going to have to remove all of those too&hellip;</p>
<h2 id="deleting-previous-versions">Deleting previous versions</h2>
<p>You can find every version of every object in a bucket with a <code>list-object-versions</code> request like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3api list-object-versions --bucket $BUCKET --max-items <span style="color:#ae81ff">500</span> --query<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{Objects: Versions[0:500].{Key:Key,VersionId:VersionId}}&#39;</span>
</span></span></code></pre></div><p>This returns the first 500 records - which is plenty to handle at a time. <a href="https://docs.aws.amazon.com/cli/latest/reference/s3api/list-object-versions.html"><code>list-object-versions</code></a> is a paginated query. You may need to call it again after deletion if there are more records to delete.</p>
<p>The <code>--query</code> on the end extracts the first 500 results as a map of JSON objects of the form: <code>{ Key, VersionId }</code></p>
<p>With this information, you can then initiate a deletion of those versions with a <code>delete-objects</code> request like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3api delete-objects --bucket $BUCKET --delete <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>VERSIONS_TO_DELETE<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --query <span style="color:#e6db74">&#39;length(Deleted[*] || `[]` )&#39;</span>
</span></span></code></pre></div><p>The <code>--query</code> on the end, here, extracts either the number of items found in <code>$.Deleted</code> in the result JSON, or <code>0</code> (the length of <code>[]</code>) if <code>Deleted</code> isn&rsquo;t found.</p>
<p>That&rsquo;s pretty simple - if the result is greater than <code>0</code>, you should fetch info about the next batch of versions and delete those. This can be executed as a loop, as illustrated by the script in <a href="https://gist.github.com/instantiator/093b1727b1cf16e77dfa3218d1957610">this gist</a>.</p>
<h2 id="deleting-deletion-records">Deleting deletion records</h2>
<p>Ironically, even after you&rsquo;ve deleted every version of every object in the bucket, the bucket still isn&rsquo;t empty! There are deletion records that must be &hellip; deleted &hellip; before you can declare the bucket truly empty. <em>Fortunately, deleting a deletion record doesn&rsquo;t create more deletion records.</em></p>
<p>You can find every deletion record in a bucket with a <code>list-object-versions</code> request like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3api list-object-versions --bucket <span style="color:#e6db74">${</span>BUCKET<span style="color:#e6db74">}</span> --max-items <span style="color:#ae81ff">500</span> --query<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{Objects: DeleteMarkers[0:500].{Key:Key,VersionId:VersionId}}&#39;</span>
</span></span></code></pre></div><p>You can see that this is very similar to the object versions query above, except that it&rsquo;s looking for <code>DeleteMarkers</code>.</p>
<p>The same <code>delete-objects</code> query above can be used to delete those markers, and again - it returns the number of items deleted by use of the <code>--query</code> parameter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>aws s3api delete-objects --bucket <span style="color:#e6db74">${</span>BUCKET<span style="color:#e6db74">}</span> --delete <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>DELETION_RECORDS_TO_DELETE<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> --query <span style="color:#e6db74">&#39;length(Deleted[*] || `[]` )&#39;</span>
</span></span></code></pre></div><p>That&rsquo;s pretty simple - if the result is greater than <code>0</code>, you should fetch info about the next batch of markers and delete those. This can be executed as a loop, as illustrated by the script in <a href="https://gist.github.com/instantiator/093b1727b1cf16e77dfa3218d1957610">this gist</a>.</p>
<h2 id="making-it-easy">Making it easy</h2>
<p>I&rsquo;ve done my best to make this simple - and I&rsquo;ve popped the whole of this into a single script, which you can find in this gist:</p>
<ul>
<li><a href="https://gist.github.com/instantiator/093b1727b1cf16e77dfa3218d1957610"><code>empty-bucket.sh</code></a></li>
</ul>
<p>The script also does some extra work for you:</p>
<ul>
<li>It checks you really meant to do this! (Unless you provide the <code>-y</code> / <code>--yes</code> option)</li>
<li>It checks that the bucket exists before starting</li>
<li>It counts the number of object versions in the bucket it&rsquo;ll need to delete</li>
<li>It counts the number of deletion records in the bucket it&rsquo;ll need to delete</li>
</ul>
<p>&hellip; and that&rsquo;s it!</p>
<p>It wasn&rsquo;t a trivial problem to solve, and I&rsquo;ve built my script around solutions presented by a kind soul on StackOverflow. I&rsquo;m grateful that people share good practices, tips and tricks in this way. Being open, helps everybody.</p>
<p><strong>Best of luck ðŸ‘‹</strong></p>

            </div>
        </div>

        <div class="post-footer">
            <div class="info">
                

            </div>
        </div>

    </div>
</div>


        </div><script src="/js/bootstrap.min.js"></script>
<script src="/js/feather.min.js"></script>
<script src="/js/mastodon-timeline.umd.js"></script>
<script>
  feather.replace();
</script></body>
</html>